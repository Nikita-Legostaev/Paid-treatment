{% extends "base.html" %}
{% block content %}
<!-- Вставка стилей для страницы -->
<style>
    /* Общие настройки контейнера */
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        font-family: Arial, sans-serif;
    }

    /* Заголовки и текст */
    .header {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 20px;
        color: #333;
    }

    /* Панель управления и поля ввода */
    .control-panel {
        margin-bottom: 20px;
    }

    .input-field {
        padding: 8px;
        margin: 5px;
        width: 180px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    /* Кнопки */
    .btn {
        padding: 10px 20px;
        font-size: 14px;
        margin: 5px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
    }

    .btn-primary {
        background-color: #ff8c00;
        color: white;
    }

    .btn-primary:hover {
        background-color: #e87a00;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .btn-success {
        background-color: #4CAF50;
        color: white;
    }

    .btn-success:hover {
        background-color: #45a049;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .btn-danger {
        background-color: #e94f37;
        color: white;
    }

    .btn-danger:hover {
        background-color: #e53935;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    /* Дополнительный эффект при фокусе на кнопке */
    .btn:focus {
        outline: none;
        box-shadow: 0 0 5px rgba(255, 140, 0, 0.8);
    }

    /* Таблица */
    .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .table th, .table td {
        padding: 12px;
        border: 1px solid #ddd;
        text-align: center;
    }

    /* Действия в таблице */
    .actions button {
        margin: 0 5px;
        padding: 6px 12px;
        font-size: 14px;
        border-radius: 4px;
    }

    /* Сообщение "Нет данных" */
    .no-data {
        text-align: center;
        font-size: 16px;
        color: #888;
        padding: 20px;
    }

    /* Модальные окна */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        padding: 20px;
        justify-content: center;
        align-items: center;
    }

    .modal form {
        background: white;
        padding: 20px;
        border-radius: 5px;
        width: 400px;
        max-width: 100%;
    }

    .modal label {
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
    }

    .modal input {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
</style>

<div class="container">
    <h2 class="header">Список услуг</h2>
    
    <!-- Панель управления для выбора диапазона -->
    <div class="control-panel">
        <label>Показать с:</label>
        <input type="number" id="offset" value="0" min="0" class="input-field">
        <label>Количество на странице:</label>
        <input type="number" id="limit" value="10" min="1" class="input-field">
        <button onclick="loadServices()" class="btn btn-primary">Применить</button>
    </div>

    <!-- Кнопка для добавления новой услуги -->
    <button onclick="openAddModal()" class="btn btn-primary">Добавить услугу</button>

    <!-- Таблица услуг -->
    <table id="servicesTable" class="table">
        <thead>
            <tr>
                <th>Название</th>
                <th>Описание</th>
                <th>Цена</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            <!-- Здесь будет отображаться список услуг -->
        </tbody>
    </table>

    <!-- Модальное окно для добавления услуги -->
    <div id="addModal" class="modal">
        <form id="addForm">
            <h3>Добавить новую услугу</h3>
            <label for="addServiceName">Название услуги:</label>
            <input type="text" id="addServiceName" class="input-field">
            <label for="addDescription">Описание:</label>
            <input type="text" id="addDescription" class="input-field">
            <label for="addPrice">Цена:</label>
            <input type="number" id="addPrice" class="input-field">
            <button type="button" onclick="addService()" class="btn btn-primary">Сохранить</button>
            <button type="button" onclick="closeAddModal()" class="btn btn-danger">Отмена</button>
        </form>
    </div>

    <!-- Модальное окно для редактирования услуги -->
    <div id="editModal" class="modal">
        <form id="editForm">
            <h3>Изменить данные услуги</h3>
            <input type="hidden" id="editServiceId">
            <label for="editServiceName">Название услуги:</label>
            <input type="text" id="editServiceName" class="input-field">
            <label for="editDescription">Описание:</label>
            <input type="text" id="editDescription" class="input-field">
            <label for="editPrice">Цена:</label>
            <input type="number" id="editPrice" class="input-field">
            <button type="button" onclick="updateService()" class="btn btn-primary">Сохранить</button>
            <button type="button" onclick="closeEditModal()" class="btn btn-danger">Отмена</button>
        </form>
    </div>
</div>

<script>
    // Функция для загрузки услуг с учетом offset и limit
    async function loadServices() {
        const offset = document.getElementById('offset').value;
        const limit = document.getElementById('limit').value;
        
        try {
            const response = await fetch(`/services/all?offset=${offset}&limit=${limit}`);
            const services = await response.json();
            const tableBody = document.querySelector('#servicesTable tbody');
            tableBody.innerHTML = ''; // Очистить текущую таблицу

            if (services.length > 0) {
                services.forEach(service => {
                    const row = document.createElement('tr');
                    row.id = `service-row-${service.id}`;
                    row.innerHTML = `
                        <td>${service.service_name}</td>
                        <td>${service.description}</td>
                        <td>${service.price} ₽</td>
                        <td>
                            <button 
                                class="btn btn-primary"
                                onclick="openEditModal('${service.id}', '${service.service_name}', '${service.description}', '${service.price}')">
                                Изменить
                            </button>
                            <button 
                                class="btn btn-danger"
                                onclick="deleteService('${service.id}')">
                                Удалить
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="4" class="no-data">Нет данных для отображения</td>`;
                tableBody.appendChild(row);
            }
        } catch (error) {
            console.error('Ошибка загрузки услуг:', error);
            alert('Ошибка при загрузке данных');
        }
    }

    // Вызов загрузки услуг при старте страницы
    window.onload = loadServices;

    // Функции для добавления услуги
    function openAddModal() {
        document.getElementById('addModal').style.display = 'block';
    }

    function closeAddModal() {
        document.getElementById('addModal').style.display = 'none';
    }

    async function addService() {
        const serviceName = document.getElementById('addServiceName').value;
        const description = document.getElementById('addDescription').value;
        const price = document.getElementById('addPrice').value;

        const data = { service_name: serviceName, description, price };

        try {
            const response = await fetch('/services/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                loadServices();
                closeAddModal();
            } else {
                alert('Ошибка при добавлении услуги');
            }
        } catch (error) {
            console.error('Ошибка при добавлении услуги:', error);
            alert('Ошибка при добавлении услуги');
        }
    }

    // Функции для редактирования услуги
    function openEditModal(id, serviceName, description, price) {
        document.getElementById('editServiceId').value = id;
        document.getElementById('editServiceName').value = serviceName;
        document.getElementById('editDescription').value = description;
        document.getElementById('editPrice').value = price;
        document.getElementById('editModal').style.display = 'block';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    async function updateService() {
        const id = document.getElementById('editServiceId').value;
        const serviceName = document.getElementById('editServiceName').value;
        const description = document.getElementById('editDescription').value;
        const price = document.getElementById('editPrice').value;

        const data = { service_name: serviceName, description, price };

        try {
            const response = await fetch(`/services/update/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                loadServices();
                closeEditModal();
            } else {
                alert('Ошибка при обновлении услуги');
            }
        } catch (error) {
            console.error('Ошибка при обновлении услуги:', error);
            alert('Ошибка при обновлении услуги');
        }
    }

    // Функция для удаления услуги
    async function deleteService(id) {
        const confirmation = confirm('Вы уверены, что хотите удалить эту услугу?');
        if (confirmation) {
            try {
                const response = await fetch(`/services/delete/${id}`, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    document.getElementById(`service-row-${id}`).remove();
                } else {
                    alert('Ошибка при удалении услуги');
                }
            } catch (error) {
                console.error('Ошибка при удалении услуги:', error);
                alert('Ошибка при удалении услуги');
            }
        }
    }
</script>
{% endblock %}
