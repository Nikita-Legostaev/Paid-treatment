{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2 class="header">Список записей на прием</h2>

    <!-- Панель управления для выбора диапазона -->
    <div class="control-panel">
        <label for="offset">Показать с:</label>
        <input type="number" id="offset" value="0" min="0" class="input-field">

        <label for="limit">Количество на странице:</label>
        <input type="number" id="limit" value="10" min="1" class="input-field">

        <button onclick="loadAppointments()" class="btn btn-primary">Применить</button>
    </div>

    <!-- Кнопка для добавления новой записи -->
    <button onclick="openAddModal()" class="btn btn-success">Добавить запись</button>

    <!-- Таблица записей -->
    <table id="appointmentsTable" class="table">
        <thead>
            <tr>
                <th>Пациент</th>
                <th>Врач</th>
                <th>Отделение</th>
                <th>Услуга</th>
                <th>Дата приема</th>
                <th>Статус оплаты</th>
                <th class="actions">Действия</th>
            </tr>
        </thead>
        <tbody>
            <!-- Здесь будет отображаться список записей -->
        </tbody>
    </table>

    <!-- Модальное окно для добавления записи -->
    <div id="addModal" class="modal">
        <h3>Добавить новую запись</h3>
        <form id="addForm">
            <label>Пациент ID:</label>
            <input type="number" id="addPatientId" class="input-field">
            <label>Врач ID:</label>
            <input type="number" id="addDoctorId" class="input-field">
            <label>Отделение ID:</label>
            <input type="number" id="addDepartamentId" class="input-field">
            <label>Услуга ID:</label>
            <input type="number" id="addServiceId" class="input-field">
            <label>Дата приема:</label>
            <input type="date" id="addAppointmentDate" class="input-field">
            <label>Статус оплаты:</label>
            <input type="text" id="addPaymentStatus" class="input-field">
            <button type="button" onclick="addAppointment()" class="btn btn-success">Сохранить</button>
            <button type="button" onclick="closeAddModal()" class="btn btn-danger">Отмена</button>
        </form>
    </div>

    <!-- Модальное окно для редактирования записи -->
    <div id="editModal" class="modal">
        <h3>Изменить запись</h3>
        <form id="editForm">
            <input type="hidden" id="editAppointmentId">
            <label>Пациент ID:</label>
            <input type="number" id="editPatientId" class="input-field">
            <label>Врач ID:</label>
            <input type="number" id="editDoctorId" class="input-field">
            <label>Отделение ID:</label>
            <input type="number" id="editDepartamentId" class="input-field">
            <label>Услуга ID:</label>
            <input type="number" id="editServiceId" class="input-field">
            <label>Дата приема:</label>
            <input type="date" id="editAppointmentDate" class="input-field">
            <label>Статус оплаты:</label>
            <input type="text" id="editPaymentStatus" class="input-field">
            <button type="button" onclick="updateAppointment()" class="btn btn-success">Сохранить</button>
            <button type="button" onclick="closeEditModal()" class="btn btn-danger">Отмена</button>
        </form>
    </div>
</div>

<script>
    // Функция для загрузки записей на прием с учетом offset и limit
    async function loadAppointments() {
        const offset = document.getElementById('offset').value;
        const limit = document.getElementById('limit').value;

        try {
            const response = await fetch(`/appointments/all?offset=${offset}&limit=${limit}`);
            const appointments = await response.json();
            const tableBody = document.querySelector('#appointmentsTable tbody');
            tableBody.innerHTML = ''; // Очистить текущую таблицу

            if (appointments.length > 0) {
                appointments.forEach(appointment => {
                    const row = document.createElement('tr');
                    row.id = `appointment-row-${appointment.id}`;
                    row.innerHTML = `
                        <td>${appointment.patient_id}</td>
                        <td>${appointment.doctor_id}</td>
                        <td>${appointment.departament_id}</td>
                        <td>${appointment.service_id}</td>
                        <td>${appointment.appointment_date}</td>
                        <td>${appointment.payment_status}</td>
                        <td class="actions">
                            <button onclick="openEditModal('${appointment.id}', '${appointment.patient_id}', '${appointment.doctor_id}', '${appointment.departament_id}', '${appointment.service_id}', '${appointment.appointment_date}', '${appointment.payment_status}')"
                                    class="btn btn-primary">Изменить</button>
                            <button onclick="deleteAppointment('${appointment.id}')" class="btn btn-danger">Удалить</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="7" class="no-data">Нет данных для отображения</td>`;
                tableBody.appendChild(row);
            }
        } catch (error) {
            console.error('Ошибка загрузки записей:', error);
            alert('Ошибка при загрузке данных');
        }
    }

    // Вызов загрузки записей при старте страницы
    window.onload = loadAppointments;

    // Функции для добавления записи
    function openAddModal() {
        document.getElementById('addModal').style.display = 'block';
    }

    function closeAddModal() {
        document.getElementById('addModal').style.display = 'none';
    }

    async function addAppointment() {
        const patientId = document.getElementById('addPatientId').value;
        const doctorId = document.getElementById('addDoctorId').value;
        const departamentId = document.getElementById('addDepartamentId').value;
        const serviceId = document.getElementById('addServiceId').value;
        const appointmentDate = document.getElementById('addAppointmentDate').value;
        const paymentStatus = document.getElementById('addPaymentStatus').value;

        const data = { patient_id: patientId, doctor_id: doctorId, departament_id: departamentId, service_id: serviceId, appointment_date: appointmentDate, payment_status: paymentStatus };

        try {
            const response = await fetch('/appointments/add_appointments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                alert('Запись успешно добавлена');
                loadAppointments(); // Перезагружаем список записей
                closeAddModal(); // Закрываем окно
            } else {
                alert('Ошибка при добавлении записи');
            }
        } catch (error) {
            console.error('Ошибка добавления записи:', error);
            alert('Ошибка при добавлении записи');
        }
    }

    // Функции для редактирования записи
    function openEditModal(id, patientId, doctorId, departamentId, serviceId, appointmentDate, paymentStatus) {
        document.getElementById('editAppointmentId').value = id;
        document.getElementById('editPatientId').value = patientId;
        document.getElementById('editDoctorId').value = doctorId;
        document.getElementById('editDepartamentId').value = departamentId;
        document.getElementById('editServiceId').value = serviceId;
        document.getElementById('editAppointmentDate').value = appointmentDate;
        document.getElementById('editPaymentStatus').value = paymentStatus;
        document.getElementById('editModal').style.display = 'block';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    async function updateAppointment() {
        const id = document.getElementById('editAppointmentId').value;
        const patientId = document.getElementById('editPatientId').value;
        const doctorId = document.getElementById('editDoctorId').value;
        const departamentId = document.getElementById('editDepartamentId').value;
        const serviceId = document.getElementById('editServiceId').value;
        const appointmentDate = document.getElementById('editAppointmentDate').value;
        const paymentStatus = document.getElementById('editPaymentStatus').value;

        const data = { patient_id: patientId, doctor_id: doctorId, departament_id: departamentId, service_id: serviceId, appointment_date: appointmentDate, payment_status: paymentStatus };

        try {
            const response = await fetch(`/appointments/update_appointments/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                alert('Запись успешно обновлена');
                loadAppointments(); // Перезагружаем список записей
                closeEditModal(); // Закрываем окно
            } else {
                alert('Ошибка при обновлении записи');
            }
        } catch (error) {
            console.error('Ошибка обновления записи:', error);
            alert('Ошибка при обновлении записи');
        }
    }

    // Функция для удаления записи
    async function deleteAppointment(id) {
        if (confirm('Вы уверены, что хотите удалить запись?')) {
            try {
                const response = await fetch(`/appointments/delete_appointments/${id}`, { method: 'DELETE' });

                if (response.ok) {
                    alert('Запись успешно удалена');
                    loadAppointments(); // Перезагружаем список записей
                } else {
                    alert('Ошибка при удалении записи');
                }
            } catch (error) {
                console.error('Ошибка удаления записи:', error);
                alert('Ошибка при удалении записи');
            }
        }
    }
</script>

<style>
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    .header {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 20px;
    }
    .control-panel {
        margin-bottom: 20px;
    }
    .input-field {
        padding: 5px;
        margin: 5px;
        width: 150px;
    }
    .btn {
        padding: 8px 16px;
        font-size: 14px;
        margin: 5px;
        border: none;
        cursor: pointer;
    }
    .btn-primary {
        background-color: #ff8c00;
        color: white;
    }
    .btn-success {
        background-color: #ff7f00;
        color: white;
    }
    .btn-danger {
        background-color: #e94f37;
        color: white;
    }
    .btn:hover {
        opacity: 0.8;
    }
    .table {
        width: 100%;
        border-collapse: collapse;
    }
    .table th, .table td {
        padding: 8px;
        border: 1px solid #ddd;
        text-align: center;
    }
    .actions button {
        margin: 0 5px;
    }
    .no-data {
        text-align: center;
        font-size: 16px;
        color: #888;
    }
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        padding: 20px;
        justify-content: center;
        align-items: center;
    }
    .modal form {
        background: white;
        padding: 20px;
        border-radius: 5px;
    }
    .modal label {
        display: block;
        margin-bottom: 5px;
    }
</style>
{% endblock %}
